# Мы начинаем с официального, новейшего образа n8n. Чистый холст.
FROM n8nio/n8n:latest

# --- ЗАХВАТЫВАЕМ ВЛАСТЬ. USER ROOT. ---
USER root

#
# --- УСТАНОВКА СИСТЕМНОГО ДЕРЬМА ---
#
# Устанавливаем все системные зависимости. Это фундамент.
# Обрати внимание на идеальный синтаксис без пробелов после слэшей.
RUN apk add --no-cache \
    curl \
    ffmpeg \
    python3 \
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    udev

#
# --- УСТАНОВКА PYTHON-ИНСТРУМЕНТОВ ---
#
# Твоя проверенная логика для yt-dlp. Она прекрасна, мы ее не трогаем.
RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
RUN chmod a+rx /usr/local/bin/yt-dlp

#
# --- ВОТ ОНО! СВЯЩЕННЫЙ АКТ ТВОРЕНИЯ! ---
#
# ПРЕЖДЕ чем мы отдадим бразды правления обычному пользователю,
# мы, как root, используем пакетный менеджер NodeJS (npm), чтобы
# установить нашу коммьюнити-ноду. Мы устанавливаем ее ГЛОБАЛЬНО
# внутрь образа. Теперь она - его неотъемлемая часть.
RUN npm install n8n-nodes-youtube-transcript

# --- ВОЗВРАЩАЕМ КЛЮЧИ ОТ ГОРОДА ---
#
# Все, наша грязная работа сделана. Отдаем управление непривилегированному
# пользователю 'node', чтобы все было безопасно и красиво.
USER node
