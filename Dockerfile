# Мы начинаем с официального, новейшего образа n8n. Чистый холст.
FROM n8nio/n8n:latest

# --- СУКА, ВНИМАНИЕ ---
# Мы немедленно захватываем власть. Переключаемся на root, потому что
# только боги и админы могут устанавливать софт в этой операционке.
USER root

#
# --- ЭТО, БЛЯДЬ, СЕРДЦЕ ОПЕРАЦИИ ---
#
# Мы ставим твои пакеты (curl, ffmpeg, python3) И добавляем к ним 
# весь тот хлам, который нужен Chromium для жизни в этом враждебном мире.
# Alpine настолько минималистичен, что ему нужно объяснять, что такое шрифты,
# что такое безопасность (nss) и что такое рендеринг графики.
# Это не установка. Это, блядь, создание системы жизнеобеспечения.
RUN apk add --no-cache \\
    curl \\
    ffmpeg \\
    python3 \\
    chromium \\
    nss \\
    freetype \\
    harfbuzz \\
    ca-certificates \\
    ttf-freefont \\
    udev

#
# --- ТВОЯ ПРОВЕРЕННАЯ ЛОГИКА ОСТАЕТСЯ НЕТРОНУТОЙ ---
#
# Мы по-прежнему крадем последнюю версию yt-dlp с GitHub, потому что
# это единственно верный способ обойти все защиты и пакетные менеджеры.
RUN curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp

# Мы по-прежнему даем ему право на жизнь.
RUN chmod a+rx /usr/local/bin/yt-dlp

# Все, власть больше не нужна. Возвращаем ключи от города обычному
# пользователю 'node', чтобы Railway и секьюрити-параноики были счастливы.
USER node

ARG CACHE_BUSTER=20250722092812
